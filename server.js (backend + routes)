const express = require('express');
const bodyParser = require('body-parser');
const sqlite3 = require('sqlite3').verbose();
const path = require('path');

const app = express();
const PORT = process.env.PORT || 3000;

// ==== Setup ====
app.set('view engine', 'ejs');
app.set('views', path.join(__dirname, 'views'));
app.use(bodyParser.urlencoded({ extended: true }));
app.use(express.static(path.join(__dirname, 'public')));

// ==== Database ====
const db = new sqlite3.Database('./data/sales.db', err => {
  if(err) console.log(err);
  else console.log('Database connected');
});

// ==== Routes ====

// หน้า Dashboard
app.get('/', (req, res) => {
  db.all('SELECT * FROM customers', [], (err, customers) => {
    if(err) console.log(err);
    else res.render('dashboard', { customers });
  });
});

// หน้าเพิ่ม/ดูลูกค้า
app.get('/customers', (req, res) => {
  db.all('SELECT * FROM customers', [], (err, customers) => {
    if(err) console.log(err);
    else res.render('customers', { customers });
  });
});

app.post('/customers', (req, res) => {
  const name = req.body.name;
  db.run('INSERT INTO customers(name) VALUES(?)', [name], err => {
    if(err) console.log(err);
    res.redirect('/customers');
  });
});

// หน้าใส่เลขขาย
app.get('/sell', (req,res)=>{
  db.all('SELECT * FROM customers',[],(err,customers)=>{
    res.render('sell',{customers});
  });
});

app.post('/sell',(req,res)=>{
  const { customer_id, number, type, amount } = req.body;
  const timestamp = new Date().toISOString();
  db.run(
    'INSERT INTO sales(customer_id, number, type, amount, timestamp) VALUES(?,?,?,?,?)',
    [customer_id, number, type, amount, timestamp],
    err => { if(err) console.log(err); }
  );
  res.redirect('/sell');
});

// เริ่มเซิร์ฟเวอร์
app.listen(PORT, () => {
  console.log(`Server running at http://localhost:${PORT}`);
});
